#!/usr/bin/env lua

---@param msg string
local function log(msg)
  io.stdout:write("[INFO] " .. msg .. "\n")
  io.stdout:flush()
end

---@param msg string
local function logError(msg)
  io.stderr:write("[ERROR] " .. msg .. "\n")
  io.stderr:flush()
end

---@return number
local function getSpotifyVolume()
  local playerctl = io.popen("playerctl -p spotify volume", "r")
  if not playerctl then
    logError("Failed to get volume")
    return 0
  end

  local volume = tonumber(playerctl:read("*a"))
  playerctl:close()

  return volume or 0
end

---@param volume number
local function setSpotifyVolume(volume)
  os.execute("playerctl -p spotify volume " .. volume)
end

local function main()
  local isMuted = false
  local savedVolume = 0

  local stream = io.popen("playerctl -p spotify metadata --follow --format '{{mpris:trackid}}'", "r")
  if not stream then
    logError("Failed to run playerctl --follow")
    return
  end

  for trackId in stream:lines() do
    local isAd = trackId:match("/com/spotify/ad/") ~= nil

    if isAd and not isMuted then
      savedVolume = getSpotifyVolume()
      setSpotifyVolume(0)
      isMuted = true
      log("Ad detected — muting Spotify")
    elseif not isAd and isMuted then
      setSpotifyVolume(savedVolume)
      isMuted = false
      log("Ad ended — restoring volume")
    end
  end

  stream:close()
  logError("Playerctl stream ended unexpectedly")
end

main()
